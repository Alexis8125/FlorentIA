---
import "../../styles/global.css";
import Menu from "../../components/Menu.astro";
---
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="/logo-fondo.jpg" />
  <title>¡FlorentIA! - Home Student</title>
</head>
<body>
  <div class="container">
    <aside class="menu">
      <Menu />
    </aside>
    <main class="information">
      <section class="welcome">
        <div class="child-image">
          <img src="/logo-fondo.jpg" alt="Logo FlorentIA" />
        </div>
        <h1 id="welcome-message">Cargando…</h1>
        <p>Tus Avances</p>
      </section>

      <section class="advance-content" id="advance-content">
        <!-- Aquí se inyectarán las tarjetas dinámicamente -->
      </section>
    </main>
  </div>

  <style global>
    .advance-content {
   display: grid;
   grid-auto-flow: column;
   grid-auto-columns: minmax(260px, 1fr);
   column-gap: 16px;     
   padding: 1rem 2rem;
   overflow-x: auto;
   background-color: transparent;  
 }
 
 .card-tema {
   background-color: #f5f5dc;      
   border-radius: 30px;
   box-shadow: 0 2px 8px rgba(0,0,0,0.1);
   padding: 1rem;
   margin: 0.5rem 0;    
   display: flex;
   flex-direction: column;
   align-items: center;
   transition: transform 0.2s ease;
 }
 .card-tema:hover {
   transform: translateY(-4px);   
 }
   
 </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "...",
      authDomain: "florentia-f47b9.firebaseapp.com",
      projectId: "florentia-f47b9",
      storageBucket: "florentia-f47b9.appspot.com",
      messagingSenderId: "59886187087",
      appId: "1:59886187087:web:d274071e62e43f00b5b03a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

   // Generador de HTML reutilizable para el círculo de progreso

   const createProgressCircleHTML = percent => `
    <div class="container-progress">
      <svg class="progress-circle" width="100" height="100" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="gradienteProgreso" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#f8dcb0"/>
            <stop offset="100%" stop-color="#f8dcb0"/>
          </linearGradient>
        </defs>
        <!-- aro de fondo (beige pálido) -->
        <circle class="bg" cx="50" cy="50" r="45" stroke-width="40px"></circle>
        <!-- progreso en sólido #f8dcb0 -->
        <circle class="progress" cx="50" cy="50" r="45" fill="#f5f5dc" stroke-width="10"
                stroke-dasharray="283"
                stroke-dashoffset="${283 - (283 * percent / 100)}"
                stroke="url(#gradienteProgreso)"></circle>
        <!-- Texto del porcentaje centrado -->
        <text class="percent-text" x="50" y="55" text-anchor="middle" font-size="24" 
              font-weight="bold" fill="#333">${percent}%</text>
      </svg>
    </div>
  `;

    (async () => {
      const code = localStorage.getItem("codigoEstudiante");
      const welcomeEl = document.getElementById("welcome-message");
      const advanceContent = document.getElementById("advance-content");
      

      if (!code) {
        welcomeEl.textContent = "¡Bienvenido a FlorentIA!";
        return;
      }

      try {
        // Obtener datos de usuario
        const userRef = doc(db, "users", code);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          welcomeEl.textContent = "¡Bienvenido a FlorentIA!";
          return;
        }
        const userData = userSnap.data();
        const name = `${userData.firstName} ${userData.lastName}`;
        welcomeEl.textContent = `¡Bienvenido, ${name}!`;

        // Determinar carpeta de módulos según grado
        const course = userData.course || "";
        let gradeFolder = "";
        if (course.startsWith("6")) gradeFolder = "sixth";
        else if (course.startsWith("7")) gradeFolder = "seventh";
        else gradeFolder = null;

        if (!gradeFolder) {
          advanceContent.innerHTML = "<p>No se encontraron módulos para tu curso.</p>";
          return;
        }

        // Obtener módulos de Firestore
        const moduleRef = doc(db, "modules", "moduleId", gradeFolder, `module${capitalize(gradeFolder)}`);
        const moduleSnap = await getDoc(moduleRef);
        if (!moduleSnap.exists()) {
          advanceContent.innerHTML = "<p>No hay temas disponibles.</p>";
          return;
        }
        const moduleData = moduleSnap.data();
        const topics = moduleData.topics || [];

        // Progreso de ejemplo (reemplaza por datos reales)
        const progresoManual = [30, 50, 95, 45];

        advanceContent.innerHTML = "";

        // Renderizar cada tarjeta
        topics.forEach((topic, index) => {
          const progreso = progresoManual[index] || 0;
          const card = document.createElement("div");
          card.classList.add("card-tema");
          card.innerHTML = createProgressCircleHTML(progreso) + `
            <h2 class="tema-titulo">${topic}</h2>
            <p class="tema-subtitulo">${moduleData.subject}</p>
          `;
          advanceContent.appendChild(card);
        });

      } catch (error) {
        console.error("Error al cargar datos:", error);
        welcomeEl.textContent = "¡Bienvenido a FlorentIA!";
      }
    })();

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
  </script>



</body>
</html>


<style>
  /* Reset y layout general */
  html, body {
    margin: 0; padding: 0;
    width: 100vw; height: 100vh;
    overflow: hidden;
    background-color: #FFFFF0;
    font-family: sans-serif;
  }
  .container {
    display: flex;
    height: 100%;
  }
  .menu {
    width: 300px;
    height: 100%;
    border-right: 1px solid #ccc;
    background: #fff;
  }
  .information {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
  }

  /* sección de bienvenida */
  .welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 0;
    color: #333;
  }
  .welcome h1 {
    font-size: 28px;
    font-weight: 400;
    margin: 0;
  }
  .welcome p {
    font-size: 34px;
    font-weight: 700;
    margin: 0.5rem 0 0;
  }
  .child-image {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    overflow: hidden;
    margin-bottom: 1rem;
  }
  .child-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .tema-titulo {
    margin: 0.5rem 0 0;
    font-size: 1.25rem;
    font-weight: 500;
    color: #333;
  }
  .tema-subtitulo {
    margin: 0.25rem 0 0;
    font-size: 1rem;
    color: #555;
  }

  /* contenedor claro tipo papel */
  .container-progress {
    background-color: transparent; 
    width: 100px; 
    height: 100px;
    margin-bottom: .5rem;
  }
  .progress-circle {
    position: relative; 
    transform: rotate(-90deg);
  }

  .percent-text {
    transform: rotate(90deg);
    transform-origin: 50px 50px;
  }

</style>

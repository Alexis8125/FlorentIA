<!DOCTYPE html>
<html lang="es" data-astro-cid-qi6rkanx>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/FlorentIA/">
    <link rel="icon" type="image/svg+xml" href="/logo-fondo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>Mis profesores</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        body{
            font-family: 'Poppins';
            margin: 0;
            padding: 0;
            background-color: ivory;
        }

        .container{
            display: flex;
            height: 100vh;
        }

        a{
            text-decoration: none;
            color: black;
        }
        
        .menu{
            width: 300px;
            height: 100%;
            background: #fff;
            border-right: 1px solid #e0e0e0;
        }
        
        .container-menu {
            border-style: solid;
            background-color: ivory;
            border-width: .5px;
            flex-direction: column;
            width: 300px;
            height: 100vh;
            display: flex;
        }

        .container-logo {
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 180px;
            display: flex;
        }

        .logo {
            height: 280px;
        }

        .option {
            border-style: solid;
            border-width: .5px;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 85px;
            display: flex;
        }

        @media (hover:hover) {
            .option:hover {
                cursor: pointer;
                background-color: beige;
            }
        }

        .text {
            font-size: 24px;
        }

        .information {
            width: calc(100% - 300px);
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }   

        .section-title{
            width: 100%;
            height: 25%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .section-title >h2{
            color:#184D6D;
            font-size: 40px;
        }

        .teacher-profile {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .teacher-card {
            width: 100%;
            max-width: 620px;
            background-color:#fefee2;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid rgba(204, 204, 204, 0.25);
        }

        .avatar-wrapper {
            background-color: #e9aa61;
            border-radius: 50%;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .teacher-avatar {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            object-fit: cover;
        }

        .teacher-details {
            display: flex;
            flex-direction: column;
            margin-left: 16px;
            flex: 1;
        }

        .teacher-details h2 {
            color: #184D6D;
            font-size: 18px;
            margin: 0;
        }

        .teacher-details h3 {
            color: #538802;
            font-size: 14px;
            margin: 5px 0 0 0;
        }

        .profile-button {
            background-color: #538802;
            color: #f3ebeb;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.3s;
            cursor: pointer;
            border: none;
            font-family: 'Poppins';
        }

        .profile-button:hover {
            background-color: #406a01;
        }

        .teacher-sections {
            width: 100%;
            height: 25%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 25px;
        }

        .teacher-card-section {
            width: 80%;
            max-width: 800px;
            height: 250px;
            background-color: #FDE0A3;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 60px;
            padding: 20px;
        }

        .teacher-card-section > h2 {
            font-size: 20px;
            color: #184D6D;
            margin-bottom: 15px;
        }

        .mensajes-container {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }

        .mensaje {
            padding: 12px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #288b98;
        }

        .mensaje-cabecera {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .mensaje-cabecera strong {
            color: #184D6D;
        }

        .mensaje-cabecera .fecha {
            color: #6c757d;
            font-size: 12px;
        }

        .mensaje-texto {
            color: #333;
            line-height: 1.5;
        }

        .loading, .no-messages {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
        }

        .error button {
            background: #288b98;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #FFFFF0;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }

        .modal-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
        }

        .modal-title h2 {
            color: #184D6D;
            margin: 0;
            font-size: 24px;
        }

        .modal-title h3 {
            color: #538802;
            margin: 5px 0 0 0;
            font-size: 18px;
        }

        .modal-body {
            padding: 10px 0;
        }

        .modal-section {
            margin-bottom: 15px;
        }

        .modal-section h4 {
            color: #184D6D;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .modal-section p {
            color: #333;
            margin: 0;
            font-size: 14px;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: black;
        }
    </style>
</head>

<body data-astro-cid-qi6rkanx>
    <div class="container" data-astro-cid-qi6rkanx>
        <aside class="menu" data-astro-cid-koxvx4t6>
            <div class="container-menu">
                <div class="container-logo"> 
                    <a href="/Home/" class="content-home"> 
                        <img src="/logo-fondo.jpg" alt="" class="logo"> 
                    </a>
                </div>
                <div class="option"> 
                    <a href="/Garden/" class="selection h-full w-full flex items-center justify-center"> 
                        <span class="text text-center">Mí Jardín</span> 
                    </a> 
                </div>
                <div class="option"> 
                    <a href="/Challenges/" class="selection h-full w-full flex items-center justify-center"> 
                        <span class="text">Mis Retos</span> 
                    </a> 
                </div>
                <div class="option"> 
                    <a href="/Achievements/" class="selection h-full w-full flex items-center justify-center"> 
                        <span class="text">Mis Logros</span> 
                    </a> 
                </div>
                <div class="option"> 
                    <a href="/Explore/" class="selection h-full w-full flex items-center justify-center"> 
                        <span class="text" style="font-family: 'Poppins', sans-serif;">Explorar</span> 
                    </a> 
                </div>
                <div class="option"> 
                    <a href="/Diary/" class="selection h-full w-full flex items-center justify-center"> 
                        <span class="text" style="font-family: 'Poppins', sans-serif;">Mí Diario</span> 
                    </a> 
                </div>
                <div class="option"> 
                    <a href="/My-teachers/" class="selection h-full w-full flex items-center justify-center"> 
                        <span class="text" style="font-family: 'Poppins', sans-serif;">Mis Profesores</span> 
                    </a> 
                </div>
            </div>
        </aside>
        <div class="information" data-astro-cid-qi6rkanx>
            <div class="section-title" data-astro-cid-qi6rkanx>
                <h2 data-astro-cid-qi6rkanx>Mis profesores</h2>
            </div>
            <div class="teacher-profile" data-astro-cid-qi6rkanx>
                <div class="teacher-card" data-astro-cid-qi6rkanx> 
                    <div class="avatar-wrapper">
                        <img id="fotoProfesor" class="teacher-avatar" src="https://cdn-icons-png.freepik.com/256/14024/14024680.png?semt=ais_hybrid" alt="Foto de la profesor@">
                    </div>
                    <div class="teacher-details" data-astro-cid-qi6rkanx>
                        <h2 id="nombreProfesor" data-astro-cid-qi6rkanx>Profe</h2>
                        <h3 id="gradoProfesor" data-astro-cid-qi6rkanx>Inglés</h3>
                    </div> 
                    <button class="profile-button" data-astro-cid-qi6rkanx>Ver perfil</button>
                </div>
            </div>
            <div class="teacher-sections" data-astro-cid-qi6rkanx>
                <div class="teacher-card-section" data-astro-cid-qi6rkanx>
                    <h2 data-astro-cid-qi6rkanx>Mensajes del profesor</h2>
                    <div id="mensajes-container" class="mensajes-container" data-astro-cid-qi6rkanx>
                        <p class="loading">Cargando mensajes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="teacher-modal" class="modal" data-astro-cid-qi6rkanx>
        <div class="modal-content" data-astro-cid-qi6rkanx> 
            <span class="close-modal">&times;</span>
            <div class="modal-header" data-astro-cid-qi6rkanx> 
                <img id="modal-teacher-avatar" class="modal-avatar" src="https://cdn-icons-png.freepik.com/256/14024/14024680.png?semt=ais_hybrid" alt="Foto del profesor">
                <div class="modal-title" data-astro-cid-qi6rkanx>
                    <h2 id="modal-teacher-name" data-astro-cid-qi6rkanx></h2>
                    <h3 id="modal-teacher-course" data-astro-cid-qi6rkanx></h3>
                </div>
            </div>
            <div class="modal-body" data-astro-cid-qi6rkanx>
                <div class="modal-section" data-astro-cid-qi6rkanx>
                    <h4 data-astro-cid-qi6rkanx>Descripción</h4>
                    <p id="modal-teacher-description" data-astro-cid-qi6rkanx></p>
                </div>
                <div class="modal-section" data-astro-cid-qi6rkanx>
                    <h4 data-astro-cid-qi6rkanx>Rol</h4>
                    <p id="modal-teacher-role" data-astro-cid-qi6rkanx></p>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCgq36r1pfgHplUt7-HSIY_qNJiEybaIJc",
            authDomain: "florentia-f47b9.firebaseapp.com",
            projectId: "florentia-f47b9",
            storageBucket: "florentia-f47b9.firebasestorage.app",
            messagingSenderId: "59886187087",
            appId: "1:59886187087:web:d274071e62e43f00b5b03a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function cargarMensajes() {
            const mensajesContainer = document.getElementById("mensajes-container");

            try {
                const codigoEstudiante = localStorage.getItem("codigoEstudiante");
                if (!codigoEstudiante) {
                    throw new Error("No se encontró código de estudiante");
                }

                const studentQuery = query(
                    collection(db, "users"),
                    where("code", "==", codigoEstudiante)
                );
                const studentSnap = await getDocs(studentQuery);

                if (studentSnap.empty) {
                    throw new Error("Estudiante no registrado");
                }

                const studentId = studentSnap.docs[0].id;

                const q = query(
                    collection(db, "messages"),
                    where("to", "==", studentId),
                    orderBy("timestamp", "desc")
                );

                mensajesContainer.innerHTML = "<p class='loading'>Cargando mensajes...</p>";
                const querySnapshot = await getDocs(q);

                mensajesContainer.innerHTML = "";

                if (querySnapshot.empty) {
                    mensajesContainer.innerHTML = "<p class='no-messages'>No tienes mensajes aún</p>";
                    return;
                }

                const nombreProfesor = document.getElementById("nombreProfesor").textContent;

                querySnapshot.forEach((doc) => {
                    const msg = doc.data();
                    const fecha = msg.timestamp?.toDate()?.toLocaleString('es-ES', {
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) || "Fecha desconocida";

                    mensajesContainer.innerHTML += `
                    <div class="mensaje">
                        <div class="mensaje-cabecera">
                            <strong>${nombreProfesor}</strong>
                            <span class="fecha">${fecha}</span>
                        </div>
                        <div class="mensaje-texto">${msg.message || "Sin contenido"}</div>
                    </div>
                `;
                });

            } catch (error) {
                console.error("Error en cargarMensajes():", error);
                mensajesContainer.innerHTML = `
                <p class="error">
                    Error al cargar mensajes: ${error.message}
                </p>
            `;
            }
        }

        async function cargarProfesor() {
            const codigoEstudiante = localStorage.getItem("codigoEstudiante");

            if (!codigoEstudiante) {
                window.location.href = "/FlorentIA/";
                return;
            }

            const studentQuery = query(
                collection(db, "users"),
                where("code", "==", codigoEstudiante)
            );
            const studentSnap = await getDocs(studentQuery);

            if (studentSnap.empty) {
                alert("No se encontró el estudiante");
                return;
            }

            const studentData = studentSnap.docs[0].data();
            const studentCourse = studentData.course;

            let courseProfesor = null;
            if (studentCourse === "601" || studentCourse === "602") {
                courseProfesor = "600";
            } else if (studentCourse === "701" || studentCourse === "702") {
                courseProfesor = "700";
            }

            if (!courseProfesor) {
                alert("Curso no válido");
                return;
            }

            const profesorQuery = query(
                collection(db, "users"),
                where("course", "==", courseProfesor.toString()),
                where("role", "==", "docente")
            );
            const profesorSnap = await getDocs(profesorQuery);

            if (profesorSnap.empty) {
                alert("No se encontraron profesores");
                return;
            }

            const profesorData = profesorSnap.docs[0].data();

            document.getElementById("nombreProfesor").textContent = profesorData.firstName + " " + profesorData.lastName;
            document.getElementById("gradoProfesor").textContent = (courseProfesor == "600") ? "Sexto" : "Séptimo";

            const fotoProfesor = profesorData.photoUrl || "https://cdn-icons-png.freepik.com/256/14024/14024680.png?semt=ais_hybrid";
            document.getElementById("fotoProfesor").src = fotoProfesor;

            document.getElementById("modal-teacher-name").textContent = profesorData.firstName + " " + profesorData.lastName;
            document.getElementById("modal-teacher-course").textContent = (courseProfesor == "600") ? "Sexto" : "Séptimo";
            document.getElementById("modal-teacher-description").textContent = profesorData.description || "No hay descripción disponible";
            document.getElementById("modal-teacher-role").textContent = "Docente";
            document.getElementById("modal-teacher-avatar").src = fotoProfesor;
        }

        document.addEventListener("DOMContentLoaded", () => {
            cargarProfesor();
            cargarMensajes();

            const modal = document.getElementById("teacher-modal");
            const btn = document.querySelector(".profile-button");
            const span = document.querySelector(".close-modal");

            btn.onclick = function () {
                modal.style.display = "block";
            }

            span.onclick = function () {
                modal.style.display = "none";
            }

            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        });

        // Script para manejar rutas en GitHub Pages
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si estamos en GitHub Pages
            if(window.location.hostname.includes('github.io')) {
                // Actualizar todas las rutas que comiencen con /
                document.querySelectorAll('a[href^="/"]').forEach(link => {
                    const href = link.getAttribute('href');
                    if(!href.startsWith('/FlorentIA/')) {
                        link.setAttribute('href', '/FlorentIA' + href);
                    }
                });
                
                // Actualizar rutas de imágenes
                document.querySelectorAll('img[src^="/"]').forEach(img => {
                    const src = img.getAttribute('src');
                    if(!src.startsWith('/FlorentIA/')) {
                        img.setAttribute('src', '/FlorentIA' + src);
                    }
                });
            }
        });
    </script>
</body>
</html>